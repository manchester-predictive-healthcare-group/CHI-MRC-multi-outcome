---
title: "TEMP_summarise_large_sample_M1C1"
author: "Alex Pate"
date: "24/11/2022"
output: word_document
---

```{r, echo=FALSE, results = 'asis'}
### Set working directory
rm(list=ls())
setwd("/mnt/bmh01-rds/mrc-multi-outcome/Project_6")
getwd()

### Load packages
source("code/z_load_packages.R")

### Assign cohort size
n.cohort <- 200000

### Assign n.pctls
n.pctls <- 20

for (scen in c(do.call(paste0, expand.grid(c("M1", "M2", "M3"), c("C1", "C2", "C3"))))){

### Define qn for confidence intervals
qn <- qnorm(0.975, 0, 1)

### Create a table for the sensitivity analysis of the IPCW methods
### Create a table for main output
tables.sens <- vector("list", 4)
tables.main <- vector("list", 4)
if (scen %in% c("M1C1", "M1C2", "M1C3")){
  ### Load worksapce
  load(paste("data/large_sample_analysis_mean_N", n.cohort, "_", scen, "_npctls", n.pctls, ".RData", sep = ""))
  
  for (i in 1:3){
  
  ### Main table
  tables.main[[i]] <- rbind(round(colMeans(p.true) - colMeans(p.est.mean[[i]]), 3),
                    paste(round(calib.aj.list[[i]], 3), 
                          "(", 
                          round(calib.aj.list[[i]] - qn*obs.aj.se, 3), 
                          ", ",
                          round(calib.aj.list[[i]] + qn*obs.aj.se, 3),
                          ")", sep = ""),
                    paste(round(calib.blr.ipcw.list[[i]]$diff.pred.obs.pspec, 3), 
                          "(", 
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.pspec - 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.pspec + 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3),
                          ")", sep = ""),
                    paste(round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.pspec, 3), 
                          "(", 
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.pspec - 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.pspec + 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3),
                          ")", sep = ""),
                    round(calib.pv.list[[i]], 3)
                    )        
  rownames(tables.main[[i]]) <- c("TRUE", "AJ", "BLR-IPCW", "MLR-IPCW", "PV")
  
  ### Sensitivity table
  tables.sens[[i]] <- rbind(round(colMeans(p.true) - colMeans(p.est.mean[[i]]), 3),
                   paste(round(calib.blr.ipcw.list[[i]]$diff.pred.obs.pspec, 3), 
                          "(", 
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.pspec - 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.pspec + 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3),
                          ")", sep = ""),
                   paste(round(calib.blr.list[[i]]$diff.pred.obs, 3), 
                          "(", 
                          round(calib.blr.list[[i]]$diff.pred.obs - 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.blr.list[[i]]$diff.pred.obs + 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs", 1:5, sep = "")], 3),
                          ")", sep = ""),
                   paste(round(calib.blr.ipcw.list[[i]]$diff.pred.obs.mspec, 3), 
                          "(", 
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.mspec - 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.mspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.mspec + 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.mspec", 1:5, sep = "")], 3),
                          ")", sep = ""),
                   paste(round(calib.blr.ipcw.list[[i]]$diff.pred.obs.DGMspec, 3), 
                          "(", 
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.DGMspec - 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.DGMspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.DGMspec + 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.DGMspec", 1:5, sep = "")], 3),
                          ")", sep = ""),
                   paste(round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.pspec, 3), 
                          "(", 
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.pspec - 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.pspec + 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3),
                          ")", sep = ""),
                   paste(round(calib.mlr.list[[i]]$diff.pred.obs, 3), 
                          "(", 
                          round(calib.mlr.list[[i]]$diff.pred.obs - 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.mlr.list[[i]]$diff.pred.obs + 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs", 1:5, sep = "")], 3),
                          ")", sep = ""),
                   paste(round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.mspec, 3), 
                          "(", 
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.mspec - 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.mspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.mspec + 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.mspec", 1:5, sep = "")], 3),
                          ")", sep = ""),
                   paste(round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.DGMspec, 3), 
                          "(", 
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.DGMspec - 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.DGMspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.DGMspec + 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.DGMspec", 1:5, sep = "")], 3),
                          ")", sep = "")
                    )
  rownames(tables.sens[[i]]) <- c("TRUE",  "BLR-IPCW", "BLR", "BLR-IPCW.m", "BLR-IPCW.DGM", "MLR-IPCW", "MLR", "MLR-IPCW.m", "MLR-IPCW.DGM")
  }
} else if (!(scen %in% c("M1C1", "M1C2", "M1C3"))){
  
  ### Load worksapce
  load(paste("data/large_sample_analysis_mean_N", n.cohort, "_", scen, ".RData", sep = ""))
  
  for (i in 1:3){
  
  tables.main[[i]] <- rbind(round(colMeans(p.true) - colMeans(p.est.mean[[i]]), 3),
                    paste(round(calib.aj.list[[i]], 3), 
                          "(", 
                          round(calib.aj.list[[i]] - qn*obs.aj.se, 3), 
                          ", ",
                          round(calib.aj.list[[i]] + qn*obs.aj.se, 3),
                          ")", sep = ""),
                    paste(round(calib.blr.ipcw.list[[i]]$diff.pred.obs.pspec, 3), 
                          "(", 
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.pspec - 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.pspec + 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3),
                          ")", sep = ""),
                    paste(round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.pspec, 3), 
                          "(", 
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.pspec - 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.pspec + 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3),
                          ")", sep = "")
                    )        
    rownames(tables.main[[i]]) <- c("TRUE", "AJ", "BLR-IPCW", "MLR-IPCW")
  
  ### Sensitivity table
  tables.sens[[i]] <- rbind(round(colMeans(p.true) - colMeans(p.est.mean[[i]]), 3),
                   paste(round(calib.blr.ipcw.list[[i]]$diff.pred.obs.pspec, 3), 
                          "(", 
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.pspec - 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.pspec + 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3),
                          ")", sep = ""),
                   paste(round(calib.blr.list[[i]]$diff.pred.obs, 3), 
                          "(", 
                          round(calib.blr.list[[i]]$diff.pred.obs - 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.blr.list[[i]]$diff.pred.obs + 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs", 1:5, sep = "")], 3),
                          ")", sep = ""),
                   paste(round(calib.blr.ipcw.list[[i]]$diff.pred.obs.mspec, 3), 
                          "(", 
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.mspec - 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.mspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.mspec + 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.mspec", 1:5, sep = "")], 3),
                          ")", sep = ""),
                   paste(round(calib.blr.ipcw.list[[i]]$diff.pred.obs.DGMspec, 3), 
                          "(", 
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.DGMspec - 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.DGMspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.blr.ipcw.list[[i]]$diff.pred.obs.DGMspec + 
                                  qn*calib.blr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.DGMspec", 1:5, sep = "")], 3),
                          ")", sep = ""),
                   paste(round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.pspec, 3), 
                          "(", 
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.pspec - 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.pspec + 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.pspec", 1:5, sep = "")], 3),
                          ")", sep = ""),
                   paste(round(calib.mlr.list[[i]]$diff.pred.obs, 3), 
                          "(", 
                          round(calib.mlr.list[[i]]$diff.pred.obs - 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.mlr.list[[i]]$diff.pred.obs + 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs", 1:5, sep = "")], 3),
                          ")", sep = ""),
                   paste(round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.mspec, 3), 
                          "(", 
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.mspec - 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.mspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.mspec + 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.mspec", 1:5, sep = "")], 3),
                          ")", sep = ""),
                   paste(round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.DGMspec, 3), 
                          "(", 
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.DGMspec - 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.DGMspec", 1:5, sep = "")], 3), 
                          ", ",
                          round(calib.mlr.ipcw.list[[i]]$diff.pred.obs.DGMspec + 
                                  qn*calib.mlr.ipcw.boot.se.list[[i]][["se"]][paste("diff.pred.obs.DGMspec", 1:5, sep = "")], 3),
                          ")", sep = "")
                    )
  rownames(tables.sens[[i]]) <- c("TRUE",  "BLR-IPCW", "BLR", "BLR-IPCW.m", "BLR-IPCW.DGM", "MLR-IPCW", "MLR", "MLR-IPCW.m", "MLR-IPCW.DGM")
  }
}

print(paste("SCENARIO = ", scen))
cat("\n")
print(paste("SCENARIO = ", scen))
cat("\n")
print(paste("SCENARIO = ", scen))
cat("\n")

### Now print the results
print("MAIN")
tables.main <- do.call("rbind", tables.main)
print(kable(tables.main))
cat("\n")

print("SENS")
tables.sens <- do.call("rbind", tables.sens)
print(kable(tables.sens))
cat("\n")

}

```
